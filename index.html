<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Espa√ßo Tai Botelho - Sistema Completo</title>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  /* Reset & base */
  * {
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  }
  body {
    margin: 0;
    background: linear-gradient(135deg, #fce4ec, #f8bbd0);
    color: #4a2c4d;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
  }

  /* Splash Screen / Login Screen */
  #splash, #loginScreen {
    flex: 1;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #ce93d8, #ba68c8);
    color: white;
    transition: opacity 0.6s ease;
    padding: 20px;
  }
  #splash h1, #loginScreen h1 {
    font-size: 3rem;
    margin-bottom: 20px;
    text-shadow: 1px 1px 4px #6d3c77;
  }
  #loginScreen {
      display: none; /* Inicia oculto, ser√° mostrado ap√≥s splash */
  }
  #loginForm {
      background: rgba(255, 255, 255, 0.9);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.2);
      text-align: center;
      color: #4a2c4d;
      max-width: 400px;
      width: 90%;
  }
  #loginForm label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      text-align: left;
  }
  #loginForm input[type="email"],
  #loginForm input[type="password"] {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ce93d8;
      border-radius: 8px;
      font-size: 1.1rem;
  }
  #loginForm button {
      background: #7b1fa2;
      border: none;
      padding: 12px 30px;
      font-size: 1.2rem;
      border-radius: 25px;
      color: white;
      cursor: pointer;
      box-shadow: 0 4px 10px #4a0072;
      transition: background-color 0.3s ease;
      margin-top: 10px; /* Adicionado para espa√ßar bot√µes de login/registro */
  }
  #loginForm button:hover {
      background: #9c27b0;
  }
  #loginError {
      color: #e53935;
      margin-top: 10px;
      font-weight: bold;
      display: none;
  }

  #btnEntrar {
    background: #7b1fa2;
    border: none;
    padding: 15px 40px;
    font-size: 1.25rem;
    border-radius: 30px;
    color: white;
    cursor: pointer;
    box-shadow: 0 6px 15px #4a0072;
    transition: background-color 0.3s ease;
  }
  #btnEntrar:hover {
    background: #9c27b0;
  }

  /* Main container */
  #main {
    display: none;
    flex: 1;
    padding: 20px;
    max-width: 1200px;
    margin: 0 auto;
    width: 100%;
  }

  /* Menu */
  .menu {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 16px;
    margin-bottom: 30px;
  }
  .menu-item {
    background: white;
    border-radius: 18px;
    box-shadow: 0 5px 15px rgb(160 75 149 / 0.3);
    cursor: pointer;
    flex: 1 1 130px;
    max-width: 150px;
    padding: 20px 10px;
    text-align: center;
    color: #7b1fa2;
    user-select: none;
    transition: transform 0.2s ease, box-shadow 0.3s ease;
  }
  .menu-item:hover {
    box-shadow: 0 8px 20px rgb(160 75 149 / 0.6);
    transform: translateY(-5px);
  }
  .menu-item span {
    font-size: 2.7rem;
    display: block;
    margin-bottom: 10px;
  }
  .menu-item p {
    font-weight: 700;
    font-size: 1.1rem;
    margin: 0;
  }
  .menu-item.logout {
    background: #e53935; /* Cor para o bot√£o de logout */
    color: white;
  }
  .menu-item.logout:hover {
      background: #c62828;
  }

  /* Sections */
  section {
    background: rgba(255 255 255 / 0.95);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 6px 18px rgb(160 75 149 / 0.25);
    max-width: 100%;
    margin-bottom: 30px;
  }
  section h3 {
    margin-top: 0;
    color: #4a2c4d;
    margin-bottom: 15px;
    border-bottom: 2px solid #ce93d8;
    padding-bottom: 6px;
  }

  /* Forms */
  .form-group {
    margin-bottom: 12px;
  }
  label {
    display: block;
    margin-bottom: 5px;
    font-weight: 600;
  }
  input, select, textarea {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1.8px solid #ce93d8;
    font-size: 1rem;
    transition: border-color 0.3s ease;
  }
  input:focus, select:focus, textarea:focus {
    border-color: #7b1fa2;
    outline: none;
  }
  textarea {
    resize: vertical;
    min-height: 60px;
  }
  button {
    background: #7b1fa2;
    border: none;
    padding: 12px 28px;
    border-radius: 30px;
    color: white;
    font-weight: 700;
    cursor: pointer;
    font-size: 1rem;
    transition: background-color 0.3s ease;
    margin-top: 10px;
    margin-right: 8px; /* Espa√ßamento entre bot√µes */
  }
  button:hover {
    background: #9c27b0;
  }

  /* Valida√ß√£o de formul√°rio */
  input.error, select.error, textarea.error {
    border-color: #e53935;
  }
  .error-message {
    color: #e53935;
    font-size: 0.85rem;
    margin-top: 4px;
    display: block;
  }

  /* Busca */
  .busca input {
    padding: 10px 12px;
    border-radius: 20px;
    border: 1.8px solid #ce93d8;
    width: 100%;
    font-size: 1rem;
    margin-bottom: 20px;
  }

  /* Listas */
  .item {
    background: #f3e5f5;
    margin-bottom: 12px;
    border-radius: 14px;
    padding: 14px 18px;
    box-shadow: 0 2px 6px rgb(160 75 149 / 0.15);
  }
  .item strong {
    font-size: 1.1rem;
    color: #6a1b9a;
  }
  .item small {
    display: block;
    margin-top: 4px;
    color: #7b1fa2cc;
  }
  .item button {
    margin-left: 0; /* Remove margin-left para melhor layout */
    margin-top: 8px;
    border-radius: 20px;
    padding: 5px 12px;
    font-size: 0.9rem;
    box-shadow: none;
  }
  .item button.editar {
    background: #9c27b0;
    color: white;
  }
  .item button.excluir {
    background: #e53935;
    color: white;
  }
  .flex-row {
    display: flex;
    gap: 10px;
    flex-wrap: wrap;
    align-items: center;
  }
  .flex-row > * {
    flex: 1 1 150px;
  }

  /* Responsive */
  @media(max-width: 768px){
    .menu {
      justify-content: center;
    }
    .menu-item {
      max-width: 120px;
      font-size: 0.9rem;
      padding: 18px 8px;
    }
    .menu-item span {
      font-size: 2rem;
    }
    button {
      width: auto; /* Permite que o width seja auto nos bot√µes */
      display: inline-block; /* Para que os bot√µes fiquem lado a lado se houver espa√ßo */
    }
    /* For√ßa bot√µes de item a irem para nova linha em telas pequenas */
    .item button {
        width: 100%;
        margin-right: 0;
    }
  }

  /* Export/Import Buttons (Backup local n√£o ser√° mais necess√°rio, mas os bot√µes permanecem para exportar/importar dados para o Firebase) */
  #backupSection {
    margin-top: 15px;
    text-align: center;
  }
  #backupSection button {
    margin: 5px;
    min-width: 120px;
  }

  /* Toast Notification */
  .toast {
      visibility: hidden;
      min-width: 250px;
      margin-left: -125px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 16px;
      position: fixed;
      z-index: 1;
      left: 50%;
      bottom: 30px;
      font-size: 17px;
      opacity: 0;
      transition: opacity 0.5s, visibility 0.5s;
  }
  .toast.show {
      visibility: visible;
      opacity: 1;
  }
</style>
</head>
<body>

<div id="splash">
  <h1>Espa√ßo Tai Botelho</h1>
  <button id="btnEntrar">Entrar</button>
</div>

<div id="loginScreen">
  <h1>Acesso Restrito</h1>
  <div id="loginForm">
    <label for="emailLogin">Email:</label>
    <input type="email" id="emailLogin" placeholder="Digite seu email" required />
    <label for="password">Senha:</label>
    <input type="password" id="password" placeholder="Digite a senha" required />
    <span id="loginError" class="error-message"></span>
    <button id="btnLogin">Acessar Sistema</button>
    <button style="background: #28a745; margin-top: 15px;" onclick="criarPrimeiroUsuarioManual()">Registrar Primeiro Acesso</button>
  </div>
</div>

<div id="main">
  <div class="menu">
    <div class="menu-item" onclick="abrirSecao('dashboardSection')"><span>üìä</span><p>Dashboard</p></div>
    <div class="menu-item" onclick="abrirSecao('clientesSection')"><span>üë•</span><p>Clientes</p></div>
    <div class="menu-item" onclick="abrirSecao('profissionaisSection')"><span>üíá‚Äç‚ôÄÔ∏è</span><p>Profissionais</p></div>
    <div class="menu-item" onclick="abrirSecao('produtosSection')"><span>üß¥</span><p>Produtos</p></div>
    <div class="menu-item" onclick="abrirSecao('agendamentosSection')"><span>üìÖ</span><p>Agendamentos</p></div>
    <div class="menu-item" onclick="abrirSecao('financeiroSection')"><span>üí∞</span><p>Financeiro</p></div>
    <div class="menu-item" onclick="abrirSecao('backupSection')"><span>üíæ</span><p>Backup</p></div>
    <div class="menu-item logout" onclick="logout()"><span>üö™</span><p>Sair</p></div>
  </div>

  <section id="dashboardSection" style="display:none;">
    <h3>Dashboard</h3>
    <p><strong>Total Clientes:</strong> <span id="dashTotalClientes">0</span></p>
    <p><strong>Total Profissionais:</strong> <span id="dashTotalProfissionais">0</span></p>
    <p><strong>Total Produtos no Estoque:</strong> <span id="dashTotalProdutos">0</span></p>
    <p><strong>Agendamentos Pendentes:</strong> <span id="dashTotalAgendamentos">0</span></p>
    <p><strong>Caixa Atual:</strong> <span id="dashCaixaAtual">R$ 0,00</span></p>

    <canvas id="graficoFinanceiro" style="max-width: 100%; margin-top:20px;"></canvas>
  </section>

  <section id="clientesSection" style="display:none;">
    <h3>Cadastro de Clientes</h3>
    <div class="form-group">
      <label for="nomeCliente">Nome:</label>
      <input type="text" id="nomeCliente" required />
      <span class="error-message" id="errorNomeCliente"></span>
    </div>
    <div class="form-group">
      <label for="telefoneCliente">Telefone:</label>
      <input type="text" id="telefoneCliente" />
    </div>
    <div class="form-group">
      <label for="emailCliente">Email:</label>
      <input type="email" id="emailCliente" />
    </div>
    <div class="form-group">
      <label for="obsCliente">Observa√ß√µes:</label>
      <textarea id="obsCliente"></textarea>
    </div>
    <button onclick="salvarCliente()">Salvar Cliente</button>
    <button onclick="limparCamposCliente()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaCliente" placeholder="Buscar cliente..." oninput="listarClientes()" />
    </div>
    <div id="listaClientes"></div>
  </section>

  <section id="profissionaisSection" style="display:none;">
    <h3>Cadastro de Profissionais</h3>
    <div class="form-group">
      <label for="nomeProf">Nome:</label>
      <input type="text" id="nomeProf" required />
      <span class="error-message" id="errorNomeProf"></span>
    </div>
    <div class="form-group">
      <label for="espProf">Especialidade:</label>
      <input type="text" id="espProf" required />
      <span class="error-message" id="errorEspProf"></span>
    </div>
    <div class="form-group">
      <label for="servicoProf">Servi√ßo Principal:</label>
      <input type="text" id="servicoProf" required />
      <span class="error-message" id="errorServicoProf"></span>
    </div>
    <div class="form-group">
      <label for="valorProf">Valor (R$):</label>
      <input type="number" id="valorProf" min="0" step="0.01" required />
      <span class="error-message" id="errorValorProf"></span>
    </div>
    <button onclick="salvarProfissional()">Salvar Profissional</button>
    <button onclick="limparCamposProfissional()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaProfissional" placeholder="Buscar profissional..." oninput="listarProfissionais()" />
    </div>
    <div id="listaProfissionais"></div>
  </section>

  <section id="produtosSection" style="display:none;">
    <h3>Cadastro de Produtos</h3>
    <div class="form-group">
      <label for="nomeProduto">Nome do Produto:</label>
      <input type="text" id="nomeProduto" required />
      <span class="error-message" id="errorNomeProduto"></span>
    </div>
    <div class="form-group">
      <label for="tipoProduto">Tipo do Produto:</label>
      <input type="text" id="tipoProduto" required />
      <span class="error-message" id="errorTipoProduto"></span>
    </div>
    <div class="form-group">
      <label for="quantidadeProduto">Quantidade em Estoque:</label>
      <input type="number" id="quantidadeProduto" min="0" required />
      <span class="error-message" id="errorQuantidadeProduto"></span>
    </div>
    <div class="form-group">
      <label for="minQuantidadeProduto">Quantidade M√≠nima para Alerta:</label>
      <input type="number" id="minQuantidadeProduto" min="0" required />
      <span class="error-message" id="errorMinQuantidadeProduto"></span>
    </div>
    <div class="form-group">
      <label for="validadeProduto">Data de Validade (opcional):</label>
      <input type="date" id="validadeProduto" />
    </div>
    <button onclick="salvarProduto()">Salvar Produto</button>
    <button onclick="limparCamposProduto()">Novo/Limpar</button>

    <div class="busca">
      <input type="text" id="buscaProduto" placeholder="Buscar produto..." oninput="listarProdutos()" />
    </div>
    <div id="listaProdutos"></div>

    <h4>Produtos em falta</h4>
    <div id="produtosEmFalta"></div>

    <h4>Usar Produto</h4>
    <div class="flex-row" style="gap: 10px; flex-wrap: nowrap; margin-bottom: 10px;">
      <select id="selectProdutoUso" style="flex-grow:1;"></select>
      <input type="number" id="quantidadeUso" min="1" placeholder="Quantidade" style="max-width: 100px;" />
      <button onclick="usarProduto()">Usar Produto</button>
    </div>

    <h4>Hist√≥rico de Movimenta√ß√µes</h4>
    <div id="historicoMovimentacoes"></div>
  </section>

  <section id="agendamentosSection" style="display:none;">
    <h3>Agendamento de Clientes</h3>
    <div class="form-group">
      <label for="selectClienteAgendamento">Cliente:</label>
      <select id="selectClienteAgendamento" required></select>
      <span class="error-message" id="errorSelectClienteAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="selectProfissionalAgendamento">Profissional:</label>
      <select id="selectProfissionalAgendamento" onchange="atualizarServicosProfissional()" required></select>
      <span class="error-message" id="errorSelectProfissionalAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="selectServicoAgendamento">Servi√ßo:</label>
      <select id="selectServicoAgendamento" required></select>
      <span class="error-message" id="errorSelectServicoAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="dataAgendamento">Data:</label>
      <input type="date" id="dataAgendamento" required />
      <span class="error-message" id="errorDataAgendamento"></span>
    </div>
    <div class="form-group">
      <label for="horaAgendamento">Hora:</label>
      <input type="time" id="horaAgendamento" required />
      <span class="error-message" id="errorHoraAgendamento"></span>
    </div>
    <button onclick="salvarAgendamento()">Salvar Agendamento</button>

    <div class="busca" style="margin-top:20px;">
      <input type="text" id="buscaAgendamento" placeholder="Buscar por nome do cliente..." oninput="listarAgendamentos()" />
    </div>
    <div class="flex-row" style="gap:10px; margin: 10px 0;">
      <label>
        <input type="checkbox" id="filtroPendentes" checked onchange="listarAgendamentos()" />
        Mostrar apenas pendentes
      </label>
      <label style="flex-grow:1;">
        Filtrar por data:
        <input type="date" id="filtroData" onchange="listarAgendamentos()" />
      </label>
      <button onclick="limparFiltrosAgendamento()">Limpar filtros</button>
    </div>

    <div id="listaAgendamentos"></div>
  </section>

  <section id="financeiroSection" style="display:none;">
    <h3>Financeiro</h3>

    <div class="form-group">
      <label for="caixaInicial">Caixa Inicial (R$):</label>
      <input type="number" id="caixaInicial" min="0" step="0.01" />
      <button onclick="salvarCaixaInicial()">Salvar Caixa Inicial</button>
    </div>

    <h4>Ganhos (Agendamentos realizados)</h4>
    <div id="listaGanhos" style="max-height: 150px; overflow-y: auto; background: #fce4ec; padding: 10px; border-radius: 12px;"></div>

    <h4>Gastos</h4>
    <div class="form-group">
      <label for="descricaoGasto">Descri√ß√£o:</label>
      <input type="text" id="descricaoGasto" required />
      <span class="error-message" id="errorDescricaoGasto"></span>
    </div>
    <div class="form-group">
      <label for="valorGasto">Valor (R$):</label>
      <input type="number" id="valorGasto" min="0" step="0.01" required />
      <span class="error-message" id="errorValorGasto"></span>
    </div>
    <div class="form-group">
      <label for="dataGasto">Data:</label>
      <input type="date" id="dataGasto" required />
      <span class="error-message" id="errorDataGasto"></span>
    </div>
    <button onclick="salvarGasto()">Salvar Gasto</button>

    <h4>Lista de Gastos</h4>
    <div id="listaGastos" style="max-height: 150px; overflow-y: auto; background: #fce4ec; padding: 10px; border-radius: 12px;"></div>

    <h4>Resumo Financeiro Mensal</h4>
    <p><strong>Caixa Atual:</strong> <span id="caixaAtual">R$ 0,00</span></p>
    <p><strong>Ganhos Totais:</strong> <span id="ganhosTotais">R$ 0,00</span></p>
    <p><strong>Gastos Totais:</strong> <span id="gastosTotais">R$ 0,00</span></p>
    <p><strong>Lucro Total:</strong> <span id="lucroTotal">R$ 0,00</span></p>
  </section>

  <section id="backupSection" style="display:none;">
    <h3>Backup e Restaura√ß√£o de Dados</h3>
    <button onclick="exportarDadosFirestore()">Exportar Dados (Firestore JSON)</button>
    <button onclick="document.getElementById('inputImportFirestore').click()">Importar Dados (Firestore JSON)</button>
    <input type="file" id="inputImportFirestore" accept="application/json" style="display:none" onchange="importarDadosFirestore(event)" />
    <p style="margin-top:20px;">*Esta fun√ß√£o de backup exporta/importa os dados do seu Firestore. N√£o √© mais necess√°rio o backup local do navegador.</p>
  </section>
</div>

<div id="toastNotification" class="toast"></div>

<script type="module">
  // Importar as fun√ß√µes necess√°rias do Firebase SDK
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, query, orderBy, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-analytics.js"; // Se voc√™ estiver usando Analytics

  // Suas configura√ß√µes do Firebase (as que voc√™ me enviou)
  const firebaseConfig = {
    apiKey: "AIzaSyAbfoZCpgltNGqzC1SKtOXBJLIiABR1Uek",
    authDomain: "tainan-salao.firebaseapp.com",
    projectId: "tainan-salao",
    storageBucket: "tainan-salao.firebasestorage.app",
    messagingSenderId: "965996001179",
    appId: "1:965996001179:web:e805a9e1087aaa9306533e",
    measurementId: "G-E6EN58PXVB"
  };

  // Inicializar Firebase
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app); // Inicializa o servi√ßo de autentica√ß√£o
  const db = getFirestore(app); // Inicializa o servi√ßo Firestore
  const analytics = getAnalytics(app); // Se voc√™ estiver usando Analytics

  // =============================================================================================================
  // VARI√ÅVEIS GLOBAIS (Ser√£o preenchidas pelo Firestore)
  // =============================================================================================================

  let clientes = [];
  let profissionais = [];
  let produtos = [];
  let agendamentos = [];
  let gastos = [];
  let caixaInicial = 0;

  // Vari√°veis de controle de edi√ß√£o
  let clienteEditandoId = null;
  let profissionalEditandoId = null;
  let produtoEditandoId = null;
  let agendamentoEditandoId = null; // Para edi√ß√£o de agendamentos

  // Objeto para formatar moeda
  const currencyFormatter = new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL',
  });

  // Fun√ß√£o para exibir notifica√ß√µes Toast
  function showToast(message, duration = 3000) {
      const toast = document.getElementById("toastNotification");
      toast.textContent = message;
      toast.classList.add("show");
      setTimeout(() => {
          toast.classList.remove("show");
      }, duration);
  }

  // Fun√ß√£o de valida√ß√£o de formul√°rio gen√©rica
  function validateField(fieldId, errorId, message) {
      const field = document.getElementById(fieldId);
      const errorSpan = document.getElementById(errorId);
      if (field.value.trim() === '') {
          field.classList.add('error');
          errorSpan.textContent = message;
          return false;
      }
      field.classList.remove('error');
      errorSpan.textContent = '';
      return true;
  }

  // =============================================================================================================
  // AUTENTICA√á√ÉO COM FIREBASE
  // =============================================================================================================

  document.getElementById("btnEntrar").onclick = () => {
    document.getElementById("splash").style.opacity = 0;
    setTimeout(() => {
      document.getElementById("splash").style.display = "none";
      document.getElementById("loginScreen").style.display = "flex";
    }, 600);
  };

  document.getElementById("btnLogin").onclick = async () => {
    const emailInput = document.getElementById("emailLogin");
    const passwordInput = document.getElementById("password");
    const loginError = document.getElementById("loginError");

    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
      loginError.textContent = "Email e senha s√£o obrigat√≥rios.";
      loginError.style.display = "block";
      emailInput.classList.toggle('error', !email);
      passwordInput.classList.toggle('error', !password);
      return;
    }

    try {
      await signInWithEmailAndPassword(auth, email, password);
      showToast("Login bem-sucedido!");
      loginError.style.display = "none";
      emailInput.classList.remove('error');
      passwordInput.classList.remove('error');
    } catch (error) {
      console.error("Erro de login:", error.code, error.message);
      let errorMessage = "Erro ao fazer login. Verifique suas credenciais.";
      if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
        errorMessage = "Email ou senha incorretos.";
      } else if (error.code === 'auth/invalid-email') {
        errorMessage = "Formato de email inv√°lido.";
      }
      loginError.textContent = errorMessage;
      loginError.style.display = "block";
      emailInput.classList.add('error');
      passwordInput.classList.add('error');
    }
  };

  // Fun√ß√£o para criar um novo usu√°rio (usada para o primeiro acesso/admin)
  async function criarPrimeiroUsuario(email, password) {
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      console.log("Usu√°rio registrado:", userCredential.user);
      showToast("Primeiro usu√°rio registrado com sucesso! Fa√ßa login.");
      document.getElementById("emailLogin").value = email;
      document.getElementById("password").value = password;
    } catch (error) {
      console.error("Erro ao registrar usu√°rio:", error.code, error.message);
      let errorMessage = "Erro ao registrar usu√°rio. Tente novamente.";
      if (error.code === 'auth/email-already-in-use') {
        errorMessage = "Este email j√° est√° em uso.";
      } else if (error.code === 'auth/weak-password') {
        errorMessage = "Senha muito fraca (m√≠nimo 6 caracteres).";
      }
      showToast(errorMessage);
    }
  }

  function criarPrimeiroUsuarioManual() {
      const email = prompt("Digite o email para o primeiro acesso/admin:");
      const password = prompt("Digite a senha para o primeiro acesso/admin (m√≠nimo 6 caracteres):");
      if (email && password) {
          criarPrimeiroUsuario(email, password);
      } else {
          showToast("Email e senha n√£o podem ser vazios.");
      }
  }

  // Observar o estado de autentica√ß√£o para redirecionar o usu√°rio
  onAuthStateChanged(auth, (user) => {
    if (user) {
      // Usu√°rio logado
      document.getElementById("loginScreen").style.opacity = 0;
      setTimeout(() => {
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("main").style.display = "block";
        abrirSecao("dashboardSection"); // Abre o dashboard ap√≥s o login
        carregarTodosOsDadosDoFirestore(); // Carrega todos os dados do Firestore
      }, 600);
    } else {
      // Usu√°rio deslogado ou n√£o logado
      if (document.getElementById("splash").style.display === "none") {
        document.getElementById("loginScreen").style.display = "flex";
        document.getElementById("main").style.display = "none";
      }
    }
  });

  async function logout() {
    try {
      await signOut(auth);
      showToast("Voc√™ foi desconectado.");
      document.getElementById("loginScreen").style.opacity = 1;
      document.getElementById("splash").style.display = "none";
      document.getElementById("main").style.display = "none";
    } catch (error) {
      console.error("Erro ao fazer logout:", error);
      showToast("Erro ao desconectar.");
    }
  }

  // =============================================================================================================
  // FUN√á√ïES DE MANIPULA√á√ÉO DO FIRESTORE
  // =============================================================================================================

  // Carregar todos os dados do Firestore e configurar listeners em tempo real
  async function carregarTodosOsDadosDoFirestore() {
      showToast("Carregando dados...");
      carregarClientesFirestore();
      carregarProfissionaisFirestore();
      carregarProdutosFirestore();
      carregarAgendamentosFirestore();
      carregarGastosFirestore();
      carregarCaixaInicialFirestore();
  }

  // Fun√ß√µes de CARREGAMENTO (onSnapshot para tempo real)
  function carregarClientesFirestore() {
      onSnapshot(query(collection(db, "clientes"), orderBy("nome", "asc")), (snapshot) => {
          clientes = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          listarClientes();
          atualizarDashboard();
          preencherSelectClienteAgendamento();
      }, (error) => { console.error("Erro ao carregar clientes:", error); showToast("Erro ao carregar clientes."); });
  }

  function carregarProfissionaisFirestore() {
      onSnapshot(query(collection(db, "profissionais"), orderBy("nome", "asc")), (snapshot) => {
          profissionais = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          listarProfissionais();
          atualizarDashboard();
          preencherSelectProfissionalAgendamento();
      }, (error) => { console.error("Erro ao carregar profissionais:", error); showToast("Erro ao carregar profissionais."); });
  }

  function carregarProdutosFirestore() {
      onSnapshot(query(collection(db, "produtos"), orderBy("nome", "asc")), (snapshot) => {
          produtos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          listarProdutos();
          listarProdutosEmFalta();
          preencherSelectProdutosUso();
          listarMovimentacoes();
          atualizarDashboard();
      }, (error) => { console.error("Erro ao carregar produtos:", error); showToast("Erro ao carregar produtos."); });
  }

  function carregarAgendamentosFirestore() {
      onSnapshot(query(collection(db, "agendamentos"), orderBy("data", "desc"), orderBy("hora", "desc")), (snapshot) => {
          agendamentos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          listarAgendamentos();
          atualizarDashboard();
          carregarFinanceiro(); // Financeiro depende dos agendamentos conclu√≠dos
          desenharGraficoFinanceiro();
      }, (error) => { console.error("Erro ao carregar agendamentos:", error); showToast("Erro ao carregar agendamentos."); });
  }

  function carregarGastosFirestore() {
      onSnapshot(query(collection(db, "gastos"), orderBy("data", "desc")), (snapshot) => {
          gastos = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
          carregarFinanceiro(); // Financeiro depende dos gastos
          desenharGraficoFinanceiro();
      }, (error) => { console.error("Erro ao carregar gastos:", error); showToast("Erro ao carregar gastos."); });
  }

  async function carregarCaixaInicialFirestore() {
      const configRef = doc(db, "configuracoes", "caixaInicial");
      try {
          const docSnap = await getDoc(configRef);
          if (docSnap.exists()) {
              caixaInicial = parseFloat(docSnap.data().valor) || 0;
          } else {
              // Se n√£o existir, crie com valor padr√£o
              await updateDoc(configRef, { valor: 0 }, { merge: true });
              caixaInicial = 0;
          }
          document.getElementById("caixaInicial").value = caixaInicial.toFixed(2);
          carregarFinanceiro();
          atualizarDashboard();
      } catch (error) {
          console.error("Erro ao carregar/criar caixa inicial:", error);
          showToast("Erro ao carregar caixa inicial.");
      }
  }

  // ================== CLIENTES ======================
  async function salvarCliente() {
    const nomeInput = document.getElementById("nomeCliente");
    const telefone = document.getElementById("telefoneCliente").value.trim();
    const email = document.getElementById("emailCliente").value.trim();
    const obs = document.getElementById("obsCliente").value.trim();

    if (!validateField('nomeCliente', 'errorNomeCliente', 'Nome √© obrigat√≥rio.')) return;

    let dados = { nome: nomeInput.value.trim(), telefone, email, obs };

    try {
      if (clienteEditandoId !== null) {
        const clienteRef = doc(db, "clientes", clienteEditandoId);
        await updateDoc(clienteRef, dados);
        showToast("Cliente atualizado com sucesso!");
      } else {
        await addDoc(collection(db, "clientes"), dados);
        showToast("Cliente salvo com sucesso!");
      }
      limparCamposCliente();
      clienteEditandoId = null;
    } catch (e) {
      console.error("Erro ao salvar cliente: ", e);
      showToast("Erro ao salvar cliente.");
    }
  }
  function limparCamposCliente() {
    document.getElementById("nomeCliente").value = "";
    document.getElementById("telefoneCliente").value = "";
    document.getElementById("emailCliente").value = "";
    document.getElementById("obsCliente").value = "";
    document.getElementById("nomeCliente").classList.remove('error');
    document.getElementById("errorNomeCliente").textContent = '';
    clienteEditandoId = null;
  }
  function listarClientes() {
    const busca = document.getElementById("buscaCliente").value.toLowerCase();
    const lista = document.getElementById("listaClientes");
    lista.innerHTML = "";
    clientes.forEach(c => {
      if (!c.nome.toLowerCase().includes(busca)) return;
      lista.innerHTML += `
      <div class="item">
        <strong>${c.nome}</strong> <small>${c.telefone || ""} | ${c.email || ""}</small><br>
        <small>${c.obs || ""}</small>
        <div>
            <button class="editar" onclick="editarCliente('${c.id}')">Editar</button>
            <button class="excluir" onclick="excluirCliente('${c.id}')">Excluir</button>
        </div>
      </div>`;
    });
  }
  function editarCliente(id) {
    const c = clientes.find(cliente => cliente.id === id);
    if (c) {
      document.getElementById("nomeCliente").value = c.nome;
      document.getElementById("telefoneCliente").value = c.telefone;
      document.getElementById("emailCliente").value = c.email;
      document.getElementById("obsCliente").value = c.obs;
      clienteEditandoId = c.id;
      showToast("Modo de edi√ß√£o de cliente.");
    }
  }
  async function excluirCliente(id) {
    if (confirm("Deseja realmente excluir este cliente?")) {
      try {
        await deleteDoc(doc(db, "clientes", id));
        showToast("Cliente exclu√≠do!");
      } catch (e) {
        console.error("Erro ao excluir cliente: ", e);
        showToast("Erro ao excluir cliente.");
      }
    }
  }

  // ================== PROFISSIONAIS ======================
  async function salvarProfissional() {
    const nomeInput = document.getElementById("nomeProf");
    const espInput = document.getElementById("espProf");
    const servicoNomeInput = document.getElementById("servicoProf");
    const valorProfInput = document.getElementById("valorProf");

    let isValid = true;
    isValid = validateField('nomeProf', 'errorNomeProf', 'Nome √© obrigat√≥rio.') && isValid;
    isValid = validateField('espProf', 'errorEspProf', 'Especialidade √© obrigat√≥ria.') && isValid;
    isValid = validateField('servicoProf', 'errorServicoProf', 'Servi√ßo √© obrigat√≥rio.') && isValid;
    
    const servValor = parseFloat(valorProfInput.value);
    if (isNaN(servValor) || servValor < 0) {
        valorProfInput.classList.add('error');
        document.getElementById("errorValorProf").textContent = 'Valor inv√°lido.';
        isValid = false;
    } else {
        valorProfInput.classList.remove('error');
        document.getElementById("errorValorProf").textContent = '';
    }

    if (!isValid) return;

    let servicos = [{ nome: servicoNomeInput.value.trim(), valor: servValor }];
    let dados = { nome: nomeInput.value.trim(), especialidade: espInput.value.trim(), servicos };

    try {
      if (profissionalEditandoId !== null) {
        const profRef = doc(db, "profissionais", profissionalEditandoId);
        await updateDoc(profRef, dados);
        showToast("Profissional atualizado com sucesso!");
      } else {
        await addDoc(collection(db, "profissionais"), dados);
        showToast("Profissional salvo com sucesso!");
      }
      limparCamposProfissional();
      profissionalEditandoId = null;
    } catch (e) {
      console.error("Erro ao salvar profissional: ", e);
      showToast("Erro ao salvar profissional.");
    }
  }
  function limparCamposProfissional() {
    document.getElementById("nomeProf").value = "";
    document.getElementById("espProf").value = "";
    document.getElementById("servicoProf").value = "";
    document.getElementById("valorProf").value = "";
    document.getElementById("nomeProf").classList.remove('error');
    document.getElementById("errorNomeProf").textContent = '';
    document.getElementById("espProf").classList.remove('error');
    document.getElementById("errorEspProf").textContent = '';
    document.getElementById("servicoProf").classList.remove('error');
    document.getElementById("errorServicoProf").textContent = '';
    document.getElementById("valorProf").classList.remove('error');
    document.getElementById("errorValorProf").textContent = '';
    profissionalEditandoId = null;
  }
  function listarProfissionais() {
    const busca = document.getElementById("buscaProfissional").value.toLowerCase();
    const lista = document.getElementById("listaProfissionais");
    lista.innerHTML = "";
    profissionais.forEach(p => {
      if (!p.nome.toLowerCase().includes(busca)) return;
      let servicosHTML = p.servicos.map(s => `<li>${s.nome} - ${currencyFormatter.format(s.valor)}</li>`).join("");
      lista.innerHTML += `
      <div class="item">
        <strong>${p.nome}</strong> <small>(${p.especialidade})</small>
        <ul>${servicosHTML}</ul>
        <div>
            <button class="editar" onclick="editarProfissional('${p.id}')">Editar</button>
            <button class="excluir" onclick="excluirProfissional('${p.id}')">Excluir</button>
        </div>
      </div>`;
    });
  }
  function editarProfissional(id) {
    const p = profissionais.find(prof => prof.id === id);
    if (p) {
      document.getElementById("nomeProf").value = p.nome;
      document.getElementById("espProf").value = p.especialidade;
      document.getElementById("servicoProf").value = p.servicos[0]?.nome || "";
      document.getElementById("valorProf").value = p.servicos[0]?.valor || "";
      profissionalEditandoId = p.id;
      showToast("Modo de edi√ß√£o de profissional.");
    }
  }
  async function excluirProfissional(id) {
    if (confirm("Deseja realmente excluir este profissional?")) {
      try {
        await deleteDoc(doc(db, "profissionais", id));
        showToast("Profissional exclu√≠do!");
      } catch (e) {
        console.error("Erro ao excluir profissional: ", e);
        showToast("Erro ao excluir profissional.");
      }
    }
  }

  // ================== PRODUTOS (Estoque avan√ßado) ======================
  async function salvarProduto() {
    const nomeInput = document.getElementById("nomeProduto");
    const tipoInput = document.getElementById("tipoProduto");
    const quantidadeInput = document.getElementById("quantidadeProduto");
    const minQtdInput = document.getElementById("minQuantidadeProduto");
    const validade = document.getElementById("validadeProduto").value;

    let isValid = true;
    isValid = validateField('nomeProduto', 'errorNomeProduto', 'Nome √© obrigat√≥rio.') && isValid;
    isValid = validateField('tipoProduto', 'errorTipoProduto', 'Tipo √© obrigat√≥rio.') && isValid;

    const quantidade = parseInt(quantidadeInput.value);
    if (isNaN(quantidade) || quantidade < 0) {
        quantidadeInput.classList.add('error');
        document.getElementById("errorQuantidadeProduto").textContent = 'Quantidade inv√°lida.';
        isValid = false;
    } else {
        quantidadeInput.classList.remove('error');
        document.getElementById("errorQuantidadeProduto").textContent = '';
    }

    const minQtd = parseInt(minQtdInput.value);
    if (isNaN(minQtd) || minQtd < 0) {
        minQtdInput.classList.add('error');
        document.getElementById("errorMinQuantidadeProduto").textContent = 'Quantidade m√≠nima inv√°lida.';
        isValid = false;
    } else {
        minQtdInput.classList.remove('error');
        document.getElementById("errorMinQuantidadeProduto").textContent = '';
    }

    if (!isValid) return;

    let dados = { nome: nomeInput.value.trim(), tipo: tipoInput.value.trim(), quantidade, minQtd, validade };

    try {
      if (produtoEditandoId !== null) {
        const produtoRef = doc(db, "produtos", produtoEditandoId);
        await updateDoc(produtoRef, dados);
        showToast("Produto atualizado com sucesso!");
      } else {
        dados.movimentacoes = []; // Inicia com array vazio de movimenta√ß√µes
        await addDoc(collection(db, "produtos"), dados);
        showToast("Produto salvo com sucesso!");
      }
      limparCamposProduto();
      produtoEditandoId = null;
    } catch (e) {
      console.error("Erro ao salvar produto: ", e);
      showToast("Erro ao salvar produto.");
    }
  }
  function limparCamposProduto() {
    document.getElementById("nomeProduto").value = "";
    document.getElementById("tipoProduto").value = "";
    document.getElementById("quantidadeProduto").value = "";
    document.getElementById("minQuantidadeProduto").value = "";
    document.getElementById("validadeProduto").value = "";
    document.getElementById("nomeProduto").classList.remove('error');
    document.getElementById("errorNomeProduto").textContent = '';
    document.getElementById("tipoProduto").classList.remove('error');
    document.getElementById("errorTipoProduto").textContent = '';
    document.getElementById("quantidadeProduto").classList.remove('error');
    document.getElementById("errorQuantidadeProduto").textContent = '';
    document.getElementById("minQuantidadeProduto").classList.remove('error');
    document.getElementById("errorMinQuantidadeProduto").textContent = '';
    produtoEditandoId = null;
  }
  function listarProdutos() {
    const busca = document.getElementById("buscaProduto").value.toLowerCase();
    const lista = document.getElementById("listaProdutos");
    lista.innerHTML = "";
    produtos.forEach(p => {
      if (!p.nome.toLowerCase().includes(busca)) return;
      const validadeText = p.validade ? ` | Validade: ${p.validade}` : "";
      lista.innerHTML += `
      <div class="item">
        <strong>${p.nome}</strong> <small>(${p.tipo})</small><br>
        <small>Quantidade: ${p.quantidade} | M√≠nimo: ${p.minQtd}${validadeText}</small><br>
        <div>
            <button class="editar" onclick="editarProduto('${p.id}')">Editar</button>
            <button class="excluir" onclick="excluirProduto('${p.id}')">Excluir</button>
        </div>
      </div>`;
    });
  }
  function listarProdutosEmFalta() {
    const div = document.getElementById("produtosEmFalta");
    div.innerHTML = "";
    const emFalta = produtos.filter(p => p.quantidade < p.minQtd);
    if (emFalta.length === 0) {
      div.textContent = "Nenhum produto em falta.";
      return;
    }
    emFalta.forEach(p => {
      div.innerHTML += `<div class="item"><strong>${p.nome}</strong> - Quantidade: ${p.quantidade} (m√≠nimo: ${p.minQtd})</div>`;
    });
  }
  function editarProduto(id) {
    const p = produtos.find(produto => produto.id === id);
    if (p) {
      document.getElementById("nomeProduto").value = p.nome;
      document.getElementById("tipoProduto").value = p.tipo;
      document.getElementById("quantidadeProduto").value = p.quantidade;
      document.getElementById("minQuantidadeProduto").value = p.minQtd;
      document.getElementById("validadeProduto").value = p.validade || "";
      produtoEditandoId = p.id;
      showToast("Modo de edi√ß√£o de produto.");
    }
  }
  async function excluirProduto(id) {
    if (confirm("Deseja realmente excluir este produto?")) {
      try {
        await deleteDoc(doc(db, "produtos", id));
        showToast("Produto exclu√≠do!");
      } catch (e) {
        console.error("Erro ao excluir produto: ", e);
        showToast("Erro ao excluir produto.");
      }
    }
  }
  function preencherSelectProdutosUso() {
    const select = document.getElementById("selectProdutoUso");
    select.innerHTML = "<option value=''>-- Selecione um produto --</option>";
    produtos.forEach(p => {
      select.innerHTML += `<option value="${p.id}">${p.nome} (Qtd: ${p.quantidade})</option>`;
    });
  }
  async function usarProduto() {
    const select = document.getElementById("selectProdutoUso");
    const produtoId = select.value;
    const qtdUsoInput = document.getElementById("quantidadeUso");
    const qtdUso = parseInt(qtdUsoInput.value);

    if (!produtoId) {
      return showToast("Selecione um produto v√°lido.");
    }
    if (isNaN(qtdUso) || qtdUso <= 0) {
      return showToast("Informe uma quantidade v√°lida para uso.");
    }

    const produto = produtos.find(p => p.id === produtoId);
    if (!produto) return showToast("Produto n√£o encontrado.");

    if (produto.quantidade < qtdUso) {
      return showToast("Quantidade insuficiente em estoque.");
    }

    try {
      const hoje = new Date().toISOString().slice(0,10);
      const updatedMovimentacoes = [...(produto.movimentacoes || []), {
        tipo: "Sa√≠da",
        quantidade: qtdUso,
        data: hoje,
        descricao: "Uso no sal√£o"
      }];

      const produtoRef = doc(db, "produtos", produtoId);
      await updateDoc(produtoRef, {
        quantidade: produto.quantidade - qtdUso,
        movimentacoes: updatedMovimentacoes
      });

      qtdUsoInput.value = "";
      select.value = "";
      showToast(`Usado ${qtdUso} de ${produto.nome}.`);
    } catch (e) {
      console.error("Erro ao usar produto: ", e);
      showToast("Erro ao usar produto.");
    }
  }
  function listarMovimentacoes() {
    const div = document.getElementById("historicoMovimentacoes");
    div.innerHTML = "";
    produtos.forEach((p) => {
      if (!p.movimentacoes || p.movimentacoes.length === 0) return;
      div.innerHTML += `<h5>${p.nome}</h5>`;
      p.movimentacoes.forEach(m => {
        div.innerHTML += `<div class="item">${m.data} - ${m.tipo}: ${m.quantidade} - ${m.descricao || ''}</div>`;
      });
    });
  }

  // ================== AGENDAMENTOS ======================
  function preencherSelectClienteAgendamento() {
    const select = document.getElementById("selectClienteAgendamento");
    select.innerHTML = "<option value=''>-- Selecione um cliente --</option>";
    clientes.forEach(c => {
      select.innerHTML += `<option value="${c.id}">${c.nome}</option>`;
    });
  }
  function preencherSelectProfissionalAgendamento() {
    const select = document.getElementById("selectProfissionalAgendamento");
    select.innerHTML = "<option value=''>-- Selecione um profissional --</option>";
    profissionais.forEach(p => {
      select.innerHTML += `<option value="${p.id}">${p.nome}</option>`;
    });
    document.getElementById("selectServicoAgendamento").innerHTML = "<option value=''>-- Selecione o servi√ßo --</option>";
  }
  function atualizarServicosProfissional() {
    const profId = document.getElementById("selectProfissionalAgendamento").value;
    const selectServico = document.getElementById("selectServicoAgendamento");
    selectServico.innerHTML = "<option value=''>-- Selecione o servi√ßo --</option>";
    const profissional = profissionais.find(p => p.id === profId);
    if (!profissional) return;
    
    profissional.servicos.forEach((s, i) => {
      selectServico.innerHTML += `<option value="${i}">${s.nome} - ${currencyFormatter.format(s.valor)}</option>`;
    });
  }
  async function salvarAgendamento() {
    const clienteId = document.getElementById("selectClienteAgendamento").value;
    const profId = document.getElementById("selectProfissionalAgendamento").value;
    const servIndex = document.getElementById("selectServicoAgendamento").value;
    const data = document.getElementById("dataAgendamento").value;
    const hora = document.getElementById("horaAgendamento").value;

    let isValid = true;
    isValid = validateField('selectClienteAgendamento', 'errorSelectClienteAgendamento', 'Cliente √© obrigat√≥rio.') && isValid;
    isValid = validateField('selectProfissionalAgendamento', 'errorSelectProfissionalAgendamento', 'Profissional √© obrigat√≥rio.') && isValid;
    isValid = validateField('selectServicoAgendamento', 'errorSelectServicoAgendamento', 'Servi√ßo √© obrigat√≥rio.') && isValid;
    isValid = validateField('dataAgendamento', 'errorDataAgendamento', 'Data √© obrigat√≥ria.') && isValid;
    isValid = validateField('horaAgendamento', 'errorHoraAgendamento', 'Hora √© obrigat√≥ria.') && isValid;

    if (!isValid) return;

    let agendamentoData = {
      clienteId,
      profId,
      servIndex: parseInt(servIndex),
      data,
      hora,
      status: "Pendente" // Sempre inicia como Pendente
    };

    try {
        if (agendamentoEditandoId !== null) {
            const agendamentoRef = doc(db, "agendamentos", agendamentoEditandoId);
            await updateDoc(agendamentoRef, agendamentoData);
            showToast("Agendamento atualizado com sucesso!");
        } else {
            await addDoc(collection(db, "agendamentos"), agendamentoData);
            showToast("Agendamento salvo com sucesso!");
        }
        limparCamposAgendamento();
        agendamentoEditandoId = null; // Reseta o ID de edi√ß√£o
    } catch (e) {
        console.error("Erro ao salvar agendamento: ", e);
        showToast("Erro ao salvar agendamento.");
    }
  }

  function limparCamposAgendamento() {
      document.getElementById("selectClienteAgendamento").value = "";
      document.getElementById("selectProfissionalAgendamento").value = "";
      document.getElementById("selectServicoAgendamento").innerHTML = "<option value=''>-- Selecione o servi√ßo --</option>";
      document.getElementById("dataAgendamento").value = "";
      document.getElementById("horaAgendamento").value = "";

      document.getElementById("selectClienteAgendamento").classList.remove('error');
      document.getElementById("errorSelectClienteAgendamento").textContent = '';
      document.getElementById("selectProfissionalAgendamento").classList.remove('error');
      document.getElementById("errorSelectProfissionalAgendamento").textContent = '';
      document.getElementById("selectServicoAgendamento").classList.remove('error');
      document.getElementById("errorSelectServicoAgendamento").textContent = '';
      document.getElementById("dataAgendamento").classList.remove('error');
      document.getElementById("errorDataAgendamento").textContent = '';
      document.getElementById("horaAgendamento").classList.remove('error');
      document.getElementById("errorHoraAgendamento").textContent = '';
      agendamentoEditandoId = null;
  }

  function listarAgendamentos() {
    const busca = document.getElementById("buscaAgendamento").value.toLowerCase();
    const filtroPendentes = document.getElementById("filtroPendentes").checked;
    const filtroData = document.getElementById("filtroData").value;

    const lista = document.getElementById("listaAgendamentos");
    lista.innerHTML = "";

    const agendamentosExibidos = agendamentos.filter(a => {
        const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "";
        if (!clienteNome.toLowerCase().includes(busca)) return false;

        if (filtroPendentes && a.status !== "Pendente") return false;
        if (filtroData && a.data !== filtroData) return false;
        return true;
    });

    agendamentosExibidos.forEach(a => {
      const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "N/A";
      const profissional = profissionais.find(p => p.id === a.profId);
      const servico = profissional?.servicos[a.servIndex];

      lista.innerHTML += `
      <div class="item">
        <strong>${clienteNome}</strong> - ${a.data} ${a.hora} <br>
        Profissional: ${profissional?.nome || "N/A"}<br>
        Servi√ßo: ${servico?.nome || "N/A"} - ${currencyFormatter.format(servico?.valor || 0)}<br>
        Status: ${a.status}
        <div>
            <button class="editar" onclick="editarAgendamento('${a.id}')">Editar</button>
            <button class="excluir" onclick="excluirAgendamento('${a.id}')">Excluir</button>
            <button onclick="alterarStatusAgendamento('${a.id}')">${a.status === 'Pendente' ? 'Concluir' : 'Reabrir'}</button>
        </div>
      </div>`;
    });
  }

  function editarAgendamento(id) {
    const a = agendamentos.find(agend => agend.id === id);
    if (a) {
      document.getElementById("selectClienteAgendamento").value = a.clienteId;
      document.getElementById("selectProfissionalAgendamento").value = a.profId;
      atualizarServicosProfissional();
      document.getElementById("selectServicoAgendamento").value = a.servIndex;
      document.getElementById("dataAgendamento").value = a.data;
      document.getElementById("horaAgendamento").value = a.hora;
      agendamentoEditandoId = a.id;
      showToast("Modo de edi√ß√£o de agendamento. Salve para confirmar.");
    }
  }

  async function excluirAgendamento(id) {
    if (confirm("Deseja realmente excluir este agendamento?")) {
      try {
        await deleteDoc(doc(db, "agendamentos", id));
        showToast("Agendamento exclu√≠do!");
      } catch (e) {
        console.error("Erro ao excluir agendamento: ", e);
        showToast("Erro ao excluir agendamento.");
      }
    }
  }
  async function alterarStatusAgendamento(id) {
    const agendamentoRef = doc(db, "agendamentos", id);
    const agendamento = agendamentos.find(a => a.id === id);
    if (agendamento) {
        const newStatus = agendamento.status === "Pendente" ? "Conclu√≠do" : "Pendente";
        try {
            await updateDoc(agendamentoRef, { status: newStatus });
            showToast(`Agendamento ${newStatus.toLowerCase()}!`);
        } catch (e) {
            console.error("Erro ao alterar status:", e);
            showToast("Erro ao alterar status do agendamento.");
        }
    }
  }
  function limparFiltrosAgendamento() {
    document.getElementById("buscaAgendamento").value = "";
    document.getElementById("filtroPendentes").checked = true;
    document.getElementById("filtroData").value = "";
    listarAgendamentos();
  }

  // ================== FINANCEIRO ======================
  async function salvarCaixaInicial() {
    const valor = parseFloat(document.getElementById("caixaInicial").value);
    if (isNaN(valor) || valor < 0) return showToast("Valor inv√°lido para o caixa inicial.");
    
    try {
        const configRef = doc(db, "configuracoes", "caixaInicial");
        await updateDoc(configRef, { valor: valor });
        showToast("Caixa inicial salvo.");
    } catch (e) {
        console.error("Erro ao salvar caixa inicial: ", e);
        showToast("Erro ao salvar caixa inicial.");
    }
  }

  function carregarFinanceiro() {
    document.getElementById("caixaInicial").value = caixaInicial.toFixed(2);

    let ganhos = 0;
    let ganhosHTML = "";
    agendamentos.forEach(a => {
      if (a.status === "Conclu√≠do") {
        const prof = profissionais.find(p => p.id === a.profId);
        const serv = prof?.servicos[a.servIndex];
        if (serv) {
          ganhos += serv.valor;
          const clienteNome = clientes.find(c => c.id === a.clienteId)?.nome || "N/A";
          ganhosHTML += `<div>${clienteNome} - Servi√ßo: ${serv.nome} - ${currencyFormatter.format(serv.valor)}</div>`;
        }
      }
    });
    document.getElementById("listaGanhos").innerHTML = ganhosHTML;

    let gastosTotal = 0;
    let gastosHTML = "";
    gastos.forEach(g => {
      gastosTotal += g.valor;
      gastosHTML += `<div>${g.data} - ${g.descricao} - ${currencyFormatter.format(g.valor)}</div>`;
    });
    document.getElementById("listaGastos").innerHTML = gastosHTML;

    const lucro = caixaInicial + ganhos - gastosTotal;
    document.getElementById("caixaAtual").textContent = currencyFormatter.format(lucro);
    document.getElementById("ganhosTotais").textContent = currencyFormatter.format(ganhos);
    document.getElementById("gastosTotais").textContent = currencyFormatter.format(gastosTotal);
    document.getElementById("lucroTotal").textContent = currencyFormatter.format(lucro);
  }
  async function salvarGasto() {
    const descricaoInput = document.getElementById("descricaoGasto");
    const valorGastoInput = document.getElementById("valorGasto");
    const dataGastoInput = document.getElementById("dataGasto");

    let isValid = true;
    isValid = validateField('descricaoGasto', 'errorDescricaoGasto', 'Descri√ß√£o √© obrigat√≥ria.') && isValid;
    isValid = validateField('dataGasto', 'errorDataGasto', 'Data √© obrigat√≥ria.') && isValid;

    const valor = parseFloat(valorGastoInput.value);
    if (isNaN(valor) || valor <= 0) {
        valorGastoInput.classList.add('error');
        document.getElementById("errorValorGasto").textContent = 'Valor inv√°lido.';
        isValid = false;
    } else {
        valorGastoInput.classList.remove('error');
        document.getElementById("errorValorGasto").textContent = '';
    }

    if (!isValid) return;

    let gastoData = { descricao: descricaoInput.value.trim(), valor, data: dataGastoInput.value };
    try {
        await addDoc(collection(db, "gastos"), gastoData);
        showToast("Gasto salvo com sucesso!");
        descricaoInput.value = "";
        valorGastoInput.value = "";
        dataGastoInput.value = "";
    } catch (e) {
        console.error("Erro ao salvar gasto: ", e);
        showToast("Erro ao salvar gasto.");
    }
  }

  // =========== DASHBOARD ==============
  function atualizarDashboard() {
    document.getElementById("dashTotalClientes").textContent = clientes.length;
    document.getElementById("dashTotalProfissionais").textContent = profissionais.length;
    document.getElementById("dashTotalProdutos").textContent = produtos.reduce((acc, p) => acc + p.quantidade, 0);
    document.getElementById("dashTotalAgendamentos").textContent = agendamentos.filter(a => a.status === "Pendente").length;
    
    const ganhosCalculados = agendamentos.reduce((acc,a) => {
      if(a.status === "Conclu√≠do"){
        const prof = profissionais.find(p => p.id === a.profId);
        if(prof && prof.servicos[a.servIndex]){
          return acc + prof.servicos[a.servIndex].valor;
        }
      }
      return acc;
    }, 0);
    const gastosCalculados = gastos.reduce((acc,g) => acc + g.valor, 0);
    const lucroAtual = caixaInicial + ganhosCalculados - gastosCalculados;
    document.getElementById("dashCaixaAtual").textContent = currencyFormatter.format(lucroAtual);
  }

  // ======= GR√ÅFICO FINANCEIRO ========
  let chartFinanceiro = null;
  function desenharGraficoFinanceiro() {
    const ctx = document.getElementById('graficoFinanceiro').getContext('2d');

    const ganhosMes = {};
    const gastosMes = {};

    agendamentos.forEach(a => {
      if (a.status !== "Conclu√≠do") return;
      const prof = profissionais.find(p => p.id === a.profId);
      const serv = prof?.servicos[a.servIndex];
      if (!serv) return;

      const mes = a.data.slice(0,7);
      ganhosMes[mes] = (ganhosMes[mes] || 0) + serv.valor;
    });

    gastos.forEach(g => {
      const mes = g.data.slice(0,7);
      gastosMes[mes] = (gastosMes[mes] || 0) + g.valor;
    });

    const meses = Array.from(new Set([...Object.keys(ganhosMes), ...Object.keys(gastosMes)])).sort();

    const ganhosData = meses.map(m => ganhosMes[m] || 0);
    const gastosData = meses.map(m => gastosMes[m] || 0);
    const lucroData = meses.map((m, i) => (ganhosData[i] - gastosData[i]));

    if(chartFinanceiro) chartFinanceiro.destroy();

    chartFinanceiro = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: meses,
        datasets: [
          {
            label: 'Ganhos',
            data: ganhosData,
            backgroundColor: 'rgba(123, 31, 162, 0.7)',
          },
          {
            label: 'Gastos',
            data: gastosData,
            backgroundColor: 'rgba(229, 57, 53, 0.7)',
          },
          {
            label: 'Lucro',
            data: lucroData,
            type: 'line',
            borderColor: 'rgba(76,175,80,1)',
            borderWidth: 3,
            fill: false,
            tension: 0.2,
            yAxisID: 'y1',
          }
        ]
      },
      options: {
        responsive: true,
        interaction: {
          mode: 'index',
          intersect: false,
        },
        scales: {
          y: {
            beginAtZero: true,
            position: 'left',
            title: {
              display: true,
              text: 'R$',
            },
            ticks: {
                callback: function(value) {
                    return currencyFormatter.format(value);
                }
            }
          },
          y1: {
            beginAtZero: true,
            position: 'right',
            grid: {
              drawOnChartArea: false,
            },
            title: {
              display: true,
              text: 'Lucro R$',
            },
            ticks: {
                callback: function(value) {
                    return currencyFormatter.format(value);
                }
            }
          }
        },
        plugins: {
          tooltip: {
            enabled: true,
            callbacks: {
                label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                        label += ': ';
                    }
                    if (context.parsed.y !== null) {
                        label += currencyFormatter.format(context.parsed.y);
                    }
                    return label;
                }
            }
          },
          legend: {
            labels: {
              boxWidth: 20,
            }
          }
        }
      }
    });
  }

  // ======= BACKUP E RESTAURA√á√ÉO (Firebase) =======
  async function exportarDadosFirestore() {
      try {
          showToast("Preparando exporta√ß√£o...");
          const allData = {
              clientes: (await getDocs(collection(db, "clientes"))).docs.map(doc => ({ id: doc.id, ...doc.data() })),
              profissionais: (await getDocs(collection(db, "profissionais"))).docs.map(doc => ({ id: doc.id, ...doc.data() })),
              produtos: (await getDocs(collection(db, "produtos"))).docs.map(doc => ({ id: doc.id, ...doc.data() })),
              agendamentos: (await getDocs(collection(db, "agendamentos"))).docs.map(doc => ({ id: doc.id, ...doc.data() })),
              gastos: (await getDocs(collection(db, "gastos"))).docs.map(doc => ({ id: doc.id, ...doc.data() })),
              caixaInicial: (await getDoc(doc(db, "configuracoes", "caixaInicial"))).data()?.valor || 0
          };

          const json = JSON.stringify(allData, null, 2);
          const blob = new Blob([json], {type: "application/json"});
          const url = URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = "backup_firestore_espaco_tai_botelho.json";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          URL.revokeObjectURL(url);
          showToast("Dados exportados com sucesso!");
      } catch (error) {
          showToast("Erro ao exportar dados: " + error.message);
          console.error("Erro ao exportar dados:", error);
      }
  }

  async function importarDadosFirestore(event) {
      const file = event.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = async (e) => {
          try {
              const dados = JSON.parse(e.target.result);
              if (!confirm("Importar ir√° substituir TODOS os dados ATUAIS no Firestore. Deseja continuar?")) {
                  event.target.value = "";
                  return;
              }

              showToast("Iniciando importa√ß√£o...");

              // Fun√ß√µes auxiliares para apagar e adicionar
              const clearAndAddCollection = async (collectionName, items) => {
                  const collectionRef = collection(db, collectionName);
                  const docs = await getDocs(collectionRef);
                  const deletePromises = docs.map(d => deleteDoc(doc(db, collectionName, d.id)));
                  await Promise.all(deletePromises);
                  
                  const addPromises = items.map(item => {
                      const { id, ...data } = item; // Separa o ID do Firestore dos demais dados
                      return setDoc(doc(db, collectionName, id || generateUUID()), data); // Usa ID existente ou gera um novo
                  });
                  await Promise.all(addPromises);
              };

              // Importar clientes
              await clearAndAddCollection("clientes", dados.clientes || []);
              // Importar profissionais
              await clearAndAddCollection("profissionais", dados.profissionais || []);
              // Importar produtos
              await clearAndAddCollection("produtos", dados.produtos || []);
              // Importar agendamentos
              await clearAndAddCollection("agendamentos", dados.agendamentos || []);
              // Importar gastos
              await clearAndAddCollection("gastos", dados.gastos || []);

              // Importar caixa inicial (documento √∫nico)
              if (typeof dados.caixaInicial !== 'undefined') {
                  await setDoc(doc(db, "configuracoes", "caixaInicial"), { valor: parseFloat(dados.caixaInicial) });
              }

              showToast("Dados importados com sucesso!");
              abrirSecao("dashboardSection"); // Recarrega o dashboard
          } catch (error) {
              showToast("Arquivo de backup inv√°lido ou erro na importa√ß√£o! " + error.message);
              console.error("Erro ao importar dados:", error);
          } finally {
              event.target.value = "";
          }
      };
      reader.readAsText(file);
  }

  // =============================================================================================================
  // INICIALIZA√á√ÉO
  // =============================================================================================================

  function abrirSecao(id) {
    document.querySelectorAll("section").forEach(sec => {
      sec.style.display = "none";
    });
    document.getElementById(id).style.display = "block";

    // Recarregar listas e selects ao abrir a se√ß√£o (onSnapshot j√° cuida de muitas atualiza√ß√µes)
    if (id === "clientesSection") {
      listarClientes();
      limparCamposCliente();
    }
    if (id === "profissionaisSection") {
      listarProfissionais();
      limparCamposProfissional();
    }
    if (id === "produtosSection") {
      listarProdutos();
      listarProdutosEmFalta();
      preencherSelectProdutosUso();
      listarMovimentacoes();
      limparCamposProduto();
    }
    if (id === "agendamentosSection") {
      preencherSelectClienteAgendamento();
      preencherSelectProfissionalAgendamento();
      listarAgendamentos();
      limparCamposAgendamento();
    }
    if (id === "financeiroSection") carregarFinanceiro();
    if (id === "dashboardSection") {
      atualizarDashboard();
      desenharGraficoFinanceiro();
    }
    if (id === "backupSection") { }
  }

  // window.onload n√£o √© mais necess√°rio para controle de login, pois onAuthStateChanged j√° faz isso
  // Ele ainda pode ser usado para outras inicializa√ß√µes que n√£o dependam do estado de autentica√ß√£o
  // Ex:
  // window.onload = () => {
  //    // Outras inicializa√ß√µes que n√£o dependem do login
  // };

</script>

</body>
</html>
